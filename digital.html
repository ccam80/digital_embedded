<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Digital Logic Simulator</title>
  <script src="https://cjrtnc.leaningtech.com/4.2/loader.js"></script>
  <style>
    html, body { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; }
    #container { width: 100vw; height: 100svh; }

    /* Loading overlay — hidden once CheerpJ takes over rendering */
    #loading-overlay {
      position: fixed; top: 0; left: 0; right: 0; bottom: 0;
      background: #f5f5f5; z-index: 9999;
      display: flex; flex-direction: column;
      align-items: center; justify-content: center;
      font-family: system-ui, sans-serif; color: #333;
    }
    #loading-overlay.hidden { display: none; }
    .spinner {
      width: 40px; height: 40px; border: 4px solid #ddd;
      border-top-color: #4285f4; border-radius: 50%;
      animation: spin 0.8s linear infinite; margin-bottom: 16px;
    }
    @keyframes spin { to { transform: rotate(360deg); } }
    #load-status { font-size: 14px; color: #666; margin-top: 8px; }
  </style>
</head>
<body>

<div id="loading-overlay">
  <div class="spinner"></div>
  <div><strong>Loading Digital Logic Simulator...</strong></div>
  <div id="load-status">Initializing CheerpJ runtime</div>
</div>

<div id="container"></div>

<script type="module">
  // ---------------------------------------------------------------------------
  // digital.html — CheerpJ Swing loader for hneemann/Digital
  //
  // Runs Digital.jar via a Launcher class that bridges the Swing app to JS
  // using CheerpJ's native method interoperability. All frame lookup and file
  // loading happens in Java (same JVM). JS only sends string file paths.
  //
  // URL parameters:
  //   dig=<url>      — Fetch a .dig circuit file from this URL and open it
  //   digData=<b64>  — Base64-encoded .dig file content (for inline circuits)
  //
  // postMessage API (parent → this frame):
  //   { type: 'digital-load-url', url: '<url>' }
  //   { type: 'digital-load-data', data: '<base64>' }
  //
  // postMessage API (this frame → parent):
  //   { type: 'digital-ready' }     — Launcher found Main frame, bridge ready
  //   { type: 'digital-loaded' }    — A checkpoint file was hot-loaded
  //   { type: 'digital-error', error: '...' }
  // ---------------------------------------------------------------------------

  const params = new URLSearchParams(window.location.search);
  const digUrl  = params.get('dig');
  const digData = params.get('digData');

  const statusEl = document.getElementById('load-status');
  function setStatus(msg) {
    statusEl.textContent = msg;
    console.log('[digital]', msg);
  }

  function sendToParent(data) {
    try { window.parent.postMessage(data, '*'); } catch(e) { /* cross-origin */ }
  }

  // Compute the CheerpJ /app/ path to Digital.jar based on this page's URL
  const basePath = window.location.pathname.substring(
    0, window.location.pathname.lastIndexOf('/')
  );
  const jarPath = '/app' + basePath + '/Digital.jar';
  const shimPath = '/app' + basePath + '/xstream-shim.jar';
  const classPath = shimPath + ':' + jarPath;

  // Counter for unique virtual file paths
  let fileCounter = 0;

  // ---------------------------------------------------------------------------
  // Command queue for the Java bridge thread.
  // waitForCommand() blocks Java until resolveCommand is called from JS.
  // If a command arrives while Java is busy, it's queued in pendingCommand.
  // ---------------------------------------------------------------------------
  let resolveCommand = null;
  let pendingCommand = null;

  function sendCommandToJava(path) {
    if (resolveCommand) {
      const r = resolveCommand;
      resolveCommand = null;
      r(path);
    } else {
      pendingCommand = path;
    }
  }

  // ---------------------------------------------------------------------------
  // Native method implementations (called from Java, run in same JVM)
  // ---------------------------------------------------------------------------

  // Blocks until JS sends a file path. Java calls this in a loop.
  async function Java_digital_launcher_Launcher_waitForCommand(lib) {
    if (pendingCommand !== null) {
      const cmd = pendingCommand;
      pendingCommand = null;
      return cmd;
    }
    return new Promise((resolve) => {
      resolveCommand = resolve;
    });
  }

  // Called once when the Launcher finds the Main frame.
  async function Java_digital_launcher_Launcher_nativeReady(lib) {
    console.log('[digital] Native bridge: Main frame found, ready');
    sendToParent({ type: 'digital-ready' });
  }

  // Called after each successful loadFile().
  async function Java_digital_launcher_Launcher_nativeLoaded(lib) {
    console.log('[digital] Native bridge: checkpoint loaded');
    sendToParent({ type: 'digital-loaded' });
  }

  // Called on error.
  async function Java_digital_launcher_Launcher_nativeError(lib, message) {
    console.error('[digital] Native bridge error:', message);
    sendToParent({ type: 'digital-error', error: String(message) });
  }

  // ---------------------------------------------------------------------------
  // Listen for postMessage commands from the parent (tutorial page)
  // ---------------------------------------------------------------------------
  window.addEventListener('message', async function(event) {
    if (!event.data || !event.data.type) return;

    if (event.data.type === 'digital-load-url') {
      try {
        // Convert URL to CheerpJ /app/ path — files are already on the web server.
        // This lets Digital resolve subcircuits relative to the file's parent dir.
        const appPath = '/app' + new URL(event.data.url, window.location.href).pathname;
        sendCommandToJava(appPath);
      } catch (e) {
        sendToParent({ type: 'digital-error', error: 'Invalid URL: ' + e });
      }
    }

    if (event.data.type === 'digital-load-data') {
      try {
        const bin = atob(event.data.data);
        const bytes = new Uint8Array(bin.length);
        for (let i = 0; i < bin.length; i++) bytes[i] = bin.charCodeAt(i);
        fileCounter++;
        const vpath = '/str/checkpoint_' + fileCounter + '.dig';
        cheerpOSAddStringFile(vpath, bytes);
        sendCommandToJava(vpath);
      } catch (e) {
        sendToParent({ type: 'digital-error', error: 'Failed to decode: ' + e });
      }
    }
  });

  // ---------------------------------------------------------------------------
  // Startup
  // ---------------------------------------------------------------------------
  try {
    setStatus('Initializing CheerpJ runtime (first load downloads ~10 MB)...');
    await cheerpjInit({
      clipboardMode: "system",
      status: "none",
      javaProperties: [
        "java.vm.vendor=CheerpJ",
        "java.specification.version=1.8",
        "java.version=1.8.0",
        "java.vendor=CheerpJ",
        "java.vm.name=CheerpJ"
      ],
      natives: {
        Java_digital_launcher_Launcher_waitForCommand,
        Java_digital_launcher_Launcher_nativeReady,
        Java_digital_launcher_Launcher_nativeLoaded,
        Java_digital_launcher_Launcher_nativeError,
      },
      overrideShortcuts: (e) => {
        if (e.ctrlKey && (e.key === 's' || e.key === 'z' || e.key === 'y')) return true;
        if (e.ctrlKey && e.key === 'a') return true;
        return false;
      }
    });

    setStatus('Creating display...');
    cheerpjCreateDisplay(-1, -1, document.getElementById("container"));

    // Load initial circuit if provided via URL params
    let circuitArg = null;
    if (digUrl) {
      // Use /app/ path — file is already on the web server, no need to fetch.
      // This also enables subcircuit resolution via the parent directory.
      circuitArg = '/app' + new URL(digUrl, window.location.href).pathname;
    } else if (digData) {
      setStatus('Decoding inline circuit data...');
      try {
        const bin = atob(digData);
        const bytes = new Uint8Array(bin.length);
        for (let i = 0; i < bin.length; i++) bytes[i] = bin.charCodeAt(i);
        cheerpOSAddStringFile("/str/circuit.dig", bytes);
        circuitArg = "/str/circuit.dig";
      } catch (e) {
        console.error('[digital] Failed to decode digData:', e);
      }
    }

    // Hide loading overlay
    setStatus('Starting Digital...');
    document.getElementById('loading-overlay').classList.add('hidden');

    // Run the Launcher, which starts Digital's Main and sets up the bridge.
    const mainClass = 'digital.launcher.Launcher';
    const args = circuitArg ? [circuitArg] : [];
    await cheerpjRunMain(mainClass, classPath, args);

  } catch (e) {
    console.error('[digital] Fatal error:', e);
    setStatus('Error: ' + e.message);
    sendToParent({ type: 'digital-error', error: String(e) });
  }
</script>
</body>
</html>
